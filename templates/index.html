<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chatbot with Voice and Typing Effect</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; }
    #chatbox { width: 400px; height: 400px; border: 1px solid #ccc; background: #fff; overflow-y: scroll; margin: 20px auto; padding: 10px; }
    .message { margin: 5px 0; }
    .user { color: blue; }
    .assistant { color: green; }
    #controls { width: 400px; margin: auto; display: flex; }
    #message { flex: 1; padding: 5px; }
    button { padding: 5px 10px; margin-left: 5px; }
  </style>
</head>
<body>
  <div id="chatbox"></div>
  <div id="controls">
    <input type="text" id="message" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="toggleMic()" id="micBtn">ðŸŽ¤</button>
  </div>

  <script>
    const chatbox = document.getElementById('chatbox');
    const messageInput = document.getElementById('message');
    let recognizing = false;
    let recognition;

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        let interim = '';
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interim += event.results[i][0].transcript;
          }
        }
        messageInput.value = finalTranscript || interim;
      };

      recognition.onend = () => {
        if (recognizing) recognition.start();
      };
    }

    function toggleMic() {
      if (!recognition) return;
      if (recognizing) {
        recognition.stop();
        recognizing = false;
        document.getElementById('micBtn').style.background = '';
      } else {
        recognition.start();
        recognizing = true;
        document.getElementById('micBtn').style.background = 'red';
      }
    }

    function appendMessage(role, text, typing = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + role;
      chatbox.appendChild(msgDiv);

      if (typing) {
        let i = 0;
        function typeChar() {
          if (i < text.length) {
            msgDiv.textContent = text.substring(0, i+1);
            i++;
            chatbox.scrollTop = chatbox.scrollHeight;
            setTimeout(typeChar, 30);
          }
        }
        typeChar();
      } else {
        msgDiv.textContent = text;
      }

      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function sendMessage() {
      const userMessage = messageInput.value.trim();
      if (!userMessage) return;

      appendMessage('user', 'You: ' + userMessage);
      messageInput.value = '';

      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userMessage })
      });

      const data = await res.json();
      if (data.reply) {
        appendMessage('assistant', 'Bot: ' + data.reply, true);
      } else if (data.error) {
        appendMessage('assistant', 'Error: ' + data.error);
      }
    }
  </script>
</body>
</html>
