<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    #chat-container { height: 90vh; overflow-y: auto; padding: 1rem; }
    .bubble { max-width: 70%; padding: 10px; margin: 8px; border-radius: 12px; }
    .user { background: #0078ff; color: #fff; margin-left: auto; }
    .assistant { background: #e5e5ea; color: #000; margin-right: auto; }
    #input-container { display: flex; padding: 10px; background: white; border-top: 1px solid #ddd; }
    #message-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; resize: none; }
    #send-btn, #mic-btn, #file-btn { margin-left: 8px; cursor: pointer; border: none; background: none; font-size: 20px; }
    #mic-btn.recording { color: red; animation: pulse 1s infinite; }
    @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
    img.preview { max-width: 120px; max-height: 120px; border-radius: 8px; margin-top: 5px; display: block; }
  </style>
</head>
<body>
  <div id="chat-container"></div>
  <div id="input-container">
    <textarea id="message-input" rows="1" placeholder="Type a message..."></textarea>
    <input type="file" id="file-input" multiple hidden>
    <button id="file-btn">üìé</button>
    <button id="mic-btn">üé§</button>
    <button id="send-btn">‚û°Ô∏è</button>
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const fileBtn = document.getElementById("file-btn");
    const fileInput = document.getElementById("file-input");

    // ‚úÖ Auto-scroll
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addBubble(text, sender, isHtml=false) {
      const div = document.createElement("div");
      div.className = "bubble " + sender;
      div.innerHTML = isHtml ? text : text.replace(/\n/g, "<br>");
      chatContainer.appendChild(div);
      scrollToBottom();
    }

    // ‚úÖ Handle sending
    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg && fileInput.files.length === 0) return;

      addBubble(msg, "user");

      const formData = new FormData();
      formData.append("message", msg);
      for (let file of fileInput.files) {
        formData.append("files", file);
      }

      recognition?.stop(); // stop mic if active
      micBtn.classList.remove("recording");

      const res = await fetch("http://127.0.0.1:5000/chat", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      addBubble(data.reply, "assistant");
      input.value = "";
      fileInput.value = "";
    }

    sendBtn.onclick = sendMessage;
    fileBtn.onclick = () => fileInput.click();

    // ‚úÖ Enter = send, Ctrl+Enter = newline
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.ctrlKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ‚úÖ Paste image support
    document.addEventListener("paste", e => {
      if (e.clipboardData.files.length > 0) {
        fileInput.files = e.clipboardData.files;
        addBubble("üìé Image pasted: " + fileInput.files[0].name, "user");
      }
    });

    // ‚úÖ Speech Recognition
    let recognition;
    let userLang = navigator.language || "en-US";
    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = userLang;

      recognition.onresult = e => {
        let transcript = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          transcript += e.results[i][0].transcript;
        }
        input.value = transcript;
      };

      recognition.onstart = () => micBtn.classList.add("recording");
      recognition.onend = () => micBtn.classList.remove("recording");
    }

    micBtn.onclick = () => {
      if (!recognition) return alert("Speech recognition not supported in this browser.");
      if (micBtn.classList.contains("recording")) {
        recognition.stop();
      } else {
        recognition.lang = userLang;
        recognition.start();
      }
    };
  </script>
</body>
</html>
