<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Assistant</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
    #chat-container { height: 90vh; overflow-y: auto; padding: 1em; display: flex; flex-direction: column; }
    .bubble { max-width: 70%; margin: .5em; padding: .8em 1em; border-radius: 1.2em; word-wrap: break-word; }
    .user { background: #007bff; color: white; align-self: flex-end; }
    .bot { background: #eaeaea; color: #333; align-self: flex-start; }
    #input-container { display: flex; padding: .5em; background: white; align-items: center; }
    #message-input { flex: 1; padding: .5em; border: 1px solid #ccc; border-radius: 6px; resize: none; }
    #send-btn, #mic-btn, #upload-btn, #clear-btn { margin-left: .5em; cursor: pointer; border: none; background: none; font-size: 1.3em; }
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .recording { color: red; animation: pulse 1s infinite; }
    @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }
  </style>
</head>
<body>
  <div id="chat-container"></div>
  <div id="input-container">
    <textarea id="message-input" rows="1" placeholder="Type a message..."></textarea>
    <button id="clear-btn">‚ùå</button>
    <button id="upload-btn">üìé</button>
    <button id="mic-btn">üé§</button>
    <button id="send-btn">‚û°Ô∏è</button>
  </div>

<script>
const chatContainer = document.getElementById("chat-container");
const input = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const micBtn = document.getElementById("mic-btn");
const uploadBtn = document.getElementById("upload-btn");
const clearBtn = document.getElementById("clear-btn");

let recognition;
let userLang = navigator.language || "en-US";
let finalTranscript = "";

// ---------- Helpers ----------
function addBubble(text, sender="bot") {
  const div = document.createElement("div");
  div.className = `bubble ${sender}`;
  div.innerHTML = text;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ---------- Send ----------
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addBubble(text, "user");
  input.value = "";
  finalTranscript = ""; // reset once sent

  // stop mic if recording
  if (recognition && micBtn.classList.contains("recording")) {
    recognition.stop();
  }

  // First try search
  let reply;
  try {
    const searchRes = await fetch("http://127.0.0.1:5000/search", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({query: text})
    });
    const searchData = await searchRes.json();
    if (searchData.result && searchData.result !== "No relevant results found.") {
      reply = searchData.result;
    }
  } catch (e) { console.warn("Search failed, falling back to GPT."); }

  // If no search result, call GPT
  if (!reply) {
    const gptRes = await fetch("http://127.0.0.1:5000/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message: text})
    });
    const gptData = await gptRes.json();
    reply = gptData.reply;
  }

  addBubble(reply, "bot");
}

sendBtn.onclick = sendMessage;

// ---------- Enter vs Ctrl+Enter ----------
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    if (e.ctrlKey) {
      input.value += "\n";
    } else {
      e.preventDefault();
      sendMessage();
    }
  }
});

// ---------- Mic ----------
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = userLang;

  recognition.onstart = () => micBtn.classList.add("recording");
  recognition.onend = () => micBtn.classList.remove("recording");

  recognition.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript + " ";
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    input.value = finalTranscript + interim;
  };
}

micBtn.onclick = () => {
  if (!recognition) {
    alert("Speech recognition not supported in this browser.");
    return;
  }
  if (micBtn.classList.contains("recording")) {
    recognition.stop();
  } else {
    finalTranscript = input.value; // preserve existing text
    recognition.lang = userLang;
    recognition.start();
  }
};

// ---------- File Upload ----------
uploadBtn.onclick = () => {
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.multiple = true;
  fileInput.onchange = () => {
    [...fileInput.files].forEach(file => {
      addBubble(`üìé ${file.name}`, "user");
      const formData = new FormData();
      formData.append("file", file);
      fetch("http://127.0.0.1:5000/upload", {method:"POST", body: formData});
    });
  };
  fileInput.click();
};

// ---------- Paste Support ----------
document.addEventListener("paste", (e) => {
  if (e.clipboardData.files.length > 0) {
    [...e.clipboardData.files].forEach(file => {
      addBubble(`üìé ${file.name}`, "user");
      const formData = new FormData();
      formData.append("file", file);
      fetch("http://127.0.0.1:5000/upload", {method:"POST", body: formData});
    });
  }
});

// ---------- Clear Input ----------
clearBtn.onclick = () => {
  input.value = "";
  finalTranscript = "";
};
</script>
</body>
</html>
