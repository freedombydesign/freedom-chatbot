<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Assistant</title>
  <style>
    body { font-family: Arial; margin:0; display:flex; flex-direction:column; height:100vh; }
    #chat-container { flex:1; overflow-y:auto; padding:1em; background:#f9f9f9; }
    .msg { margin:0.5em 0; padding:0.7em; border-radius:12px; max-width:70%; }
    .user { background:#0084ff; color:white; margin-left:auto; }
    .assistant { background:#e5e5ea; color:black; margin-right:auto; }
    #chat-input-container { display:flex; padding:0.5em; background:#fff; border-top:1px solid #ccc; align-items:center; }
    #chat-input { flex:1; resize:none; padding:0.5em; border-radius:8px; }
    button { margin-left:6px; cursor:pointer; }
    #file-preview { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .file-thumb { position:relative; width:60px; height:60px; border-radius:8px; overflow:hidden; border:1px solid #ccc; }
    .file-thumb img, .file-thumb video { width:100%; height:100%; object-fit:cover; }
    .remove { position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; font-size:0.8rem; cursor:pointer; }
  </style>
</head>
<body>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <label for="file-upload" id="attach-btn">📎</label>
    <input type="file" id="file-upload" multiple hidden accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.mp3,.wav">
    
    <textarea id="chat-input" placeholder="Type a message..."></textarea>
    <button id="mic-btn">🎤</button>
    <button id="send-btn">➤</button>
  </div>
  <div id="file-preview"></div>

<script>
const chat = document.getElementById("chat-container");
const input = document.getElementById("chat-input");
const sendBtn = document.getElementById("send-btn");
const micBtn = document.getElementById("mic-btn");
const fileUpload = document.getElementById("file-upload");
const filePreview = document.getElementById("file-preview");
let recognizing = false, recognition;

// Add messages
function addMessage(content, role="assistant") {
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.textContent = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Send message
function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, "user");
  input.value = "";

  fetch("http://localhost:5000/chat", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ user_id:"demo", message:msg })
  }).then(r=>r.json()).then(d => addMessage(d.reply, "assistant"));
}

sendBtn.onclick = sendMessage;
input.addEventListener("keypress", e => { if (e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});

// Mic logic
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true; recognition.lang="en-US";
  recognition.onresult = e => input.value += " " + e.results[e.results.length-1][0].transcript;
}
micBtn.onclick = () => {
  if (recognizing) { recognition.stop(); micBtn.textContent="🎤"; recognizing=false; }
  else { recognition.start(); micBtn.textContent="⏹"; recognizing=true; }
};

// File upload preview
fileUpload.addEventListener("change", e => handleFiles(e.target.files));
document.addEventListener("paste", e => { if(e.clipboardData.files.length>0) handleFiles(e.clipboardData.files); });
document.addEventListener("dragover", e=>e.preventDefault());
document.addEventListener("drop", e=>{e.preventDefault(); if(e.dataTransfer.files.length>0) handleFiles(e.dataTransfer.files);});

function handleFiles(files){
  Array.from(files).forEach(file=>{
    const thumb=document.createElement("div"); thumb.className="file-thumb";
    if(file.type.startsWith("image/")){
      const img=document.createElement("img"); img.src=URL.createObjectURL(file); thumb.appendChild(img);
    }else if(file.type.startsWith("video/")){
      const vid=document.createElement("video"); vid.src=URL.createObjectURL(file); thumb.appendChild(vid);
    }else thumb.textContent=file.name;
    const rm=document.createElement("button"); rm.textContent="✕"; rm.className="remove"; rm.onclick=()=>thumb.remove();
    thumb.appendChild(rm); filePreview.appendChild(thumb);
    const fd=new FormData(); fd.append("file",file);
    fetch("http://localhost:5000/upload",{method:"POST",body:fd});
  });
}
</script>
</body>
</html>
