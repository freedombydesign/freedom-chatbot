<!DOCTYPE html>
const text = document.getElementById("text");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const attachBtn = document.getElementById("attachBtn");
const fileInput = document.getElementById("fileInput");
let pendingFiles = [];
let mediaRecorder, audioChunks = [], isRecording = false;


function addMessage(msg, sender){
let div = document.createElement("div");
div.className = sender;
div.textContent = msg;
messages.appendChild(div);
messages.scrollTop = messages.scrollHeight;
}


// --- Send Message ---
function sendMessage(){
if(!text.value.trim() && pendingFiles.length===0) return;


addMessage(text.value, "user");


const formData = new FormData();
formData.append("message", text.value);
pendingFiles.forEach(f => formData.append("files", f));


text.value = "";
pendingFiles = [];
document.querySelectorAll(".preview").forEach(p=>p.remove());


fetch("/chat", {method:"POST", body: formData})
.then(r=>r.json())
.then(d=>addMessage(d.reply, "assistant"));
}


sendBtn.onclick = sendMessage;
text.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.ctrlKey){ e.preventDefault(); sendMessage(); } });


// --- Mic ---
micBtn.onclick = async ()=>{
if(!isRecording){
let stream = await navigator.mediaDevices.getUserMedia({audio:true});
mediaRecorder = new MediaRecorder(stream);
audioChunks = [];
mediaRecorder.ondataavailable = e=> audioChunks.push(e.data);
mediaRecorder.onstop = ()=>{
const audioBlob = new Blob(audioChunks, {type:"audio/webm"});
const formData = new FormData();
formData.append("audio", audioBlob);
fetch("/voice", {method:"POST", body: formData})
.then(r=>r.json())
.then(d=>{ text.value = d.transcript; });
};
mediaRecorder.start();
micBtn.textContent = "â¹ï¸";
isRecording = true;
} else {
mediaRecorder.stop();
micBtn.textContent = "ðŸŽ¤";
isRecording = false;
}
}


// --- Attach ---
attachBtn.onclick = ()=> fileInput.click();
fileInput.onchange = ()=>{
[...fileInput.files].forEach(file=>{
pendingFiles.push(file);
let prev = document.createElement("div");
prev.className="preview";
if(file.type.startsWith("image/")){
let img = document.createElement("img");
img.src = URL.createObjectURL(file);
prev.appendChild(img);
} else {
prev.textContent = file.name;
}
let removeBtn = document.createElement("span");
removeBtn.className = "remove";
removeBtn.textContent = " X";
removeBtn.onclick = ()=>{
pendingFiles = pendingFiles.filter(f=>f!==file);
prev.remove();
}
prev.appendChild(removeBtn);
messages.appendChild(prev);
});
}
</script>
</body>
</html>
